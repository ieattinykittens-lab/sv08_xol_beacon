[gcode_macro TEST_SPEED]
description: Max speed/accel test with MCU-step drift check across homing
gcode:
  ########################################################################
  # Params
  {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
  {% set iterations = params.ITERATIONS|default(5)|int %}
  {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
  {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
  {% set bound = params.BOUND|default(20)|int %}
  {% set smallpatternsize = params.SMALLPATTERNSIZE|default(20)|int %}
  # Optional override for threshold in microsteps; else use stepper_x.microsteps
  {% set microstep_threshold = params.MICROSTEP_THRESHOLD|default(printer.configfile.settings.stepper_x.microsteps|default(16))|int %}
  ########################################################################

  # Guards: require endstop_phase per-stepper blocks
  {% if 'endstop_phase stepper_x' not in printer.configfile.settings
        or 'endstop_phase stepper_y' not in printer.configfile.settings %}
    RESPOND TYPE=error MSG="TEST_SPEED requires [endstop_phase stepper_x] and [endstop_phase stepper_y] in printer.cfg. Add them, RESTART, then G28."
    ABORT MSG="Missing endstop_phase per-stepper sections"
  {% endif %}

  # Guards: require X/Y homed
  {% if 'x' not in printer.toolhead.homed_axes or 'y' not in printer.toolhead.homed_axes %}
    RESPOND TYPE=error MSG="Home X/Y (G28) before running TEST_SPEED."
    ABORT MSG="Axes not homed"
  {% endif %}

  # Bounds for large pattern
  {% set x_min = printer.toolhead.axis_minimum.x + bound %}
  {% set x_max = printer.toolhead.axis_maximum.x - bound %}
  {% set y_min = printer.toolhead.axis_minimum.y + bound %}
  {% set y_max = printer.toolhead.axis_maximum.y - bound %}

  # Small pattern box around center
  {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float)/2 %}
  {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float)/2 %}
  {% set x_center_min = x_center - (smallpatternsize/2) %}
  {% set x_center_max = x_center + (smallpatternsize/2) %}
  {% set y_center_min = y_center - (smallpatternsize/2) %}
  {% set y_center_max = y_center + (smallpatternsize/2) %}

  SAVE_GCODE_STATE NAME=TEST_SPEED
  { action_respond_info("TEST_SPEED: %d iters @ %d mm/s, accel %d, min_cruise_ratio %.2f, threshold %d µsteps"
     % (iterations, speed, accel, min_cruise_ratio, microstep_threshold)) }

  # ---------- First home & sample MCU counters ----------
  M400
  G28
  {% if printer.configfile.settings.quad_gantry_level %}
    {% if printer.quad_gantry_level.applied == False %}
      QUAD_GANTRY_LEVEL
      G28 Z
    {% endif %}
  {% endif %}
  G90
  G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
  M400
  G28 X Y
  G4 P200
  {% set x0 = printer.endstop_phase.last_home.stepper_x.mcu_position|int %}
  {% set y0 = printer.endstop_phase.last_home.stepper_y.mcu_position|int %}

  # ---------- Go start & set limits ----------
  G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}
  {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
    SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
  {% else %}
    SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel/2}
  {% endif %}

  # ---------- Patterns ----------
  {% for i in range(iterations) %}
    # Large diagonals
    G0 X{x_min} Y{y_min} F{speed*60}
    G0 X{x_max} Y{y_max} F{speed*60}
    G0 X{x_min} Y{y_min} F{speed*60}
    G0 X{x_max} Y{y_min} F{speed*60}
    G0 X{x_min} Y{y_max} F{speed*60}
    G0 X{x_max} Y{y_min} F{speed*60}
    # Large box
    G0 X{x_min} Y{y_min} F{speed*60}
    G0 X{x_min} Y{y_max} F{speed*60}
    G0 X{x_max} Y{y_max} F{speed*60}
    G0 X{x_max} Y{y_min} F{speed*60}
    # Small diagonals
    G0 X{x_center_min} Y{y_center_min} F{speed*60}
    G0 X{x_center_max} Y{y_center_max} F{speed*60}
    G0 X{x_center_min} Y{y_center_min} F{speed*60}
    G0 X{x_center_max} Y{y_center_min} F{speed*60}
    G0 X{x_center_min} Y{y_center_max} F{speed*60}
    G0 X{x_center_max} Y{y_center_min} F{speed*60}
    # Small box
    G0 X{x_center_min} Y{y_center_min} F{speed*60}
    G0 X{x_center_min} Y{y_center_max} F{speed*60}
    G0 X{x_center_max} Y{y_center_max} F{speed*60}
    G0 X{x_center_max} Y{y_center_min} F{speed*60}
  {% endfor %}

  # ---------- Restore limits, re-home & sample again ----------
  {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
  {% else %}
    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
  {% endif %}

  M400
  G28
  G4 P200
  {% set x1 = printer.endstop_phase.last_home.stepper_x.mcu_position|int %}
  {% set y1 = printer.endstop_phase.last_home.stepper_y.mcu_position|int %}

  {% set dx = x1 - x0 %}
  {% set dy = y1 - y0 %}
  {% set x_ok = (dx|abs) <= microstep_threshold %}
  {% set y_ok = (dy|abs) <= microstep_threshold %}

  { action_respond_info("RESULT ΔX=%d (≤%d -> %s), ΔY=%d (≤%d -> %s)"
     % (dx, microstep_threshold, "PASS" if x_ok else "FAIL",
        dy, microstep_threshold, "PASS" if y_ok else "FAIL")) }

  RESTORE_GCODE_STATE NAME=TEST_SPEED

