[gcode_macro TEST_SPEED]
description: Test for max speed and acceleration parameters for the printer. Procedure: Home -> ReadPositionFromMCU -> MovesToolhead@Vel&Accel -> Home -> ReadPositionfromMCU
gcode:
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    {% set iterations = params.ITERATIONS|default(5)|int %}
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
    {% set bound = params.BOUND|default(20)|int %}
    {% set smallpatternsize = params.SMALLPATTERNSIZE|default(20)|int %}

    # Use X microsteps as "full-step" threshold (assumes X/Y same microsteps)
    {% set fullstep = printer.configfile.settings.stepper_x.microsteps|default(16)|int %}

    # --- Large pattern bounds
    {% set x_min = printer.toolhead.axis_minimum.x + bound %}
    {% set x_max = printer.toolhead.axis_maximum.x - bound %}
    {% set y_min = printer.toolhead.axis_minimum.y + bound %}
    {% set y_max = printer.toolhead.axis_maximum.y - bound %}

    # --- Small pattern box around center
    {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float)/2 %}
    {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float)/2 %}
    {% set x_center_min = x_center - (smallpatternsize/2) %}
    {% set x_center_max = x_center + (smallpatternsize/2) %}
    {% set y_center_min = y_center - (smallpatternsize/2) %}
    {% set y_center_max = y_center + (smallpatternsize/2) %}

    SAVE_GCODE_STATE NAME=TEST_SPEED
    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d, min_cruise_ratio %.2f" % (iterations, speed, accel, min_cruise_ratio)) }

    # --- First home and sample MCU positions
    M400
    G28
    {% if printer.configfile.settings.quad_gantry_level %}
      {% if printer.quad_gantry_level.applied == False %}
        QUAD_GANTRY_LEVEL
        G28 Z
      {% endif %}
    {% endif %}
    G90
    G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
    M400
    G28 X Y
    G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
    G4 P300
    GET_POSITION

    # Capture initial MCU counters
    {% set x0 = printer.toolhead.mcu_position.x|int %}
    {% set y0 = printer.toolhead.mcu_position.y|int %}

    # --- Go to start
    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

    # --- Velocity limits
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
      SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
    {% else %}
      SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel/2}
    {% endif %}

    # --- Patterns
    {% for i in range(iterations) %}
      G0 X{x_min} Y{y_min} F{speed*60}
      G0 X{x_max} Y{y_max} F{speed*60}
      G0 X{x_min} Y{y_min} F{speed*60}
      G0 X{x_max} Y{y_min} F{speed*60}
      G0 X{x_min} Y{y_max} F{speed*60}
      G0 X{x_max} Y{y_min} F{speed*60}
      G0 X{x_min} Y{y_min} F{speed*60}
      G0 X{x_min} Y{y_max} F{speed*60}
      G0 X{x_max} Y{y_max} F{speed*60}
      G0 X{x_max} Y{y_min} F{speed*60}
      G0 X{x_center_min} Y{y_center_min} F{speed*60}
      G0 X{x_center_max} Y{y_center_max} F{speed*60}
      G0 X{x_center_min} Y{y_center_min} F{speed*60}
      G0 X{x_center_max} Y{y_center_min} F{speed*60}
      G0 X{x_center_min} Y{y_center_max} F{speed*60}
      G0 X{x_center_max} Y{y_center_min} F{speed*60}
      G0 X{x_center_min} Y{y_center_min} F{speed*60}
      G0 X{x_center_min} Y{y_center_max} F{speed*60}
      G0 X{x_center_max} Y{y_center_max} F{speed*60}
      G0 X{x_center_max} Y{y_center_min} F{speed*60}
    {% endfor %}

    # Restore limits
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
      SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
    {% else %}
      SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    {% endif %}

    # Re-home and sample again
    M400
    G28
    G90
    G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
    G4 P300
    GET_POSITION

    {% set x1 = printer.toolhead.mcu_position.x|int %}
    {% set y1 = printer.toolhead.mcu_position.y|int %}
    {% set dx = x1 - x0 %}
    {% set dy = y1 - y0 %}

    {% set x_ok = (dx|abs) <= fullstep %}
    {% set y_ok = (dy|abs) <= fullstep %}

    { action_respond_info("TEST_SPEED RESULT: ΔX=%d (<=%d ok:%s), ΔY=%d (<=%d ok:%s)" %
      (dx, fullstep, "PASS" if x_ok else "FAIL", dy, fullstep, "PASS" if y_ok else "FAIL")) }

    RESTORE_GCODE_STATE NAME=TEST_SPEED

