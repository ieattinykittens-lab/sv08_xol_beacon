[gcode_macro TEST_SPEED]
description: Test for max speed/accel and compare MCU steps across two homings
gcode:
  # ------------------ params ------------------
  {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
  {% set iterations = params.ITERATIONS|default(5)|int %}
  {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
  {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
  {% set bound = params.BOUND|default(20)|int %}
  {% set smallpatternsize = params.SMALLPATTERNSIZE|default(20)|int %}

  # must have endstop_phase
  {% if not printer.configfile.settings.endstop_phase %}
    { action_raise("TEST_SPEED requires [endstop_phase] in printer.cfg and a restart.") }
  {% endif %}

  # full-step threshold = microsteps on X
  {% set fullstep = printer.configfile.settings.stepper_x.microsteps|default(16)|int %}

  # ------------------ geometry ------------------
  {% set x_min = printer.toolhead.axis_minimum.x + bound %}
  {% set x_max = printer.toolhead.axis_maximum.x - bound %}
  {% set y_min = printer.toolhead.axis_minimum.y + bound %}
  {% set y_max = printer.toolhead.axis_maximum.y - bound %}

  {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float)/2 %}
  {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float)/2 %}
  {% set x_center_min = x_center - (smallpatternsize/2) %}
  {% set x_center_max = x_center + (smallpatternsize/2) %}
  {% set y_center_min = y_center - (smallpatternsize/2) %}
  {% set y_center_max = y_center + (smallpatternsize/2) %}

  SAVE_GCODE_STATE NAME=TEST_SPEED
  { action_respond_info("TEST_SPEED: iters=%d speed=%d accel=%d mcr=%.2f" % (iterations, speed, accel, min_cruise_ratio)) }

  # =======================================================
  # 1) FIRST HOME (creates endstop_phase.last_home.*)
  # =======================================================
  M400
  G28
  {% if printer.configfile.settings.quad_gantry_level %}
    {% if printer.quad_gantry_level.applied == False %}
      QUAD_GANTRY_LEVEL
      G28 Z
    {% endif %}
  {% endif %}
  G90
  G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
  M400
  G28 X Y
  G4 P150

  # After the home above, endstop_phase should now have a last_home entry.
  {% if printer.endstop_phase.last_home is not defined %}
    { action_raise("TEST_SPEED: endstop_phase has no last_home after G28. Check homing / endstops.") }
  {% endif %}

  # guard X
  {% if printer.endstop_phase.last_home.stepper_x is not defined %}
    { action_raise("TEST_SPEED: endstop_phase.last_home.stepper_x is missing. Home X with G28 X and retry.") }
  {% endif %}
  # guard Y
  {% if printer.endstop_phase.last_home.stepper_y is not defined %}
    { action_raise("TEST_SPEED: endstop_phase.last_home.stepper_y is missing. Home Y with G28 Y and retry.") }
  {% endif %}

  {% set x0 = printer.endstop_phase.last_home.stepper_x.mcu_position|int %}
  {% set y0 = printer.endstop_phase.last_home.stepper_y.mcu_position|int %}

  # =======================================================
  # 2) MOVE PATTERNS
  # =======================================================
  G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

  {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
    SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
  {% else %}
    SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel/2}
  {% endif %}

  {% for i in range(iterations) %}
    # large diagonals
    G0 X{x_min} Y{y_min} F{speed*60}
    G0 X{x_max} Y{y_max} F{speed*60}
    G0 X{x_min} Y{y_min} F{speed*60}
    G0 X{x_max} Y{y_min} F{speed*60}
    G0 X{x_min} Y{y_max} F{speed*60}
    G0 X{x_max} Y{y_min} F{speed*60}
    # large box
    G0 X{x_min} Y{y_min} F{speed*60}
    G0 X{x_min} Y{y_max} F{speed*60}
    G0 X{x_max} Y{y_max} F{speed*60}
    G0 X{x_max} Y{y_min} F{speed*60}
    # small diagonals
    G0 X{x_center_min} Y{y_center_min} F{speed*60}
    G0 X{x_center_max} Y{y_center_max} F{speed*60}
    G0 X{x_center_min} Y{y_center_min} F{speed*60}
    G0 X{x_center_max} Y{y_center_min} F{speed*60}
    G0 X{x_center_min} Y{y_center_max} F{speed*60}
    G0 X{x_center_max} Y{y_center_min} F{speed*60}
    # small box
    G0 X{x_center_min} Y{y_center_min} F{speed*60}
    G0 X{x_center_min} Y{y_center_max} F{speed*60}
    G0 X{x_center_max} Y{y_center_max} F{speed*60}
    G0 X{x_center_max} Y{y_center_min} F{speed*60}
  {% endfor %}

  # =======================================================
  # 3) RESTORE LIMITS, HOME AGAIN, SAMPLE AGAIN
  # =======================================================
  {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
  {% else %}
    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
  {% endif %}

  M400
  G28
  G4 P150

  {% if printer.endstop_phase.last_home is not defined %}
    { action_raise("TEST_SPEED: second home did not populate endstop_phase.last_home.") }
  {% endif %}
  {% if printer.endstop_phase.last_home.stepper_x is not defined or printer.endstop_phase.last_home.stepper_y is not defined %}
    { action_raise("TEST_SPEED: second home has no stepper_x/stepper_y in endstop_phase.") }
  {% endif %}

  {% set x1 = printer.endstop_phase.last_home.stepper_x.mcu_position|int %}
  {% set y1 = printer.endstop_phase.last_home.stepper_y.mcu_position|int %}

  {% set dx = x1 - x0 %}
  {% set dy = y1 - y0 %}
  {% set x_ok = (dx|abs) <= fullstep %}
  {% set y_ok = (dy|abs) <= fullstep %}

  { action_respond_info("TEST_SPEED RESULT: ΔX=%d (≤%d -> %s), ΔY=%d (≤%d -> %s)" %
    (dx, fullstep, "PASS" if x_ok else "FAIL", dy, fullstep, "PASS" if y_ok else "FAIL")) }

  RESTORE_GCODE_STATE NAME=TEST_SPEED

